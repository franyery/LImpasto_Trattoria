{% extends "base.html" %}
{% block content %}
<style>
    :root {
        --vino: #721c24;
        --dorado: #c5a059;
    }
    .directa-card { border-top: 5px solid var(--vino); border-radius: 15px; }
    .header-info { background-color: #f8f9fa; border-radius: 10px; padding: 20px; border: 1px solid #eee; }
    .table-menu thead { background-color: var(--vino); color: white; }
    .monto-grande { font-size: 1.5rem; font-weight: bold; color: var(--vino); }
    .badge-llevar { background-color: #343a40; color: white; padding: 8px 15px; border-radius: 20px; }
</style>

<div class="container py-4">
    <div class="card directa-card shadow-lg">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: var(--vino); font-family: 'Playfair Display', serif;">
                    <i class="fa-solid fa-bag-shopping me-2"></i>Nueva Venta: Para Llevar
                </h2>
                <span class="badge-llevar"><i class="fa-solid fa-motorcycle me-2"></i>Pedido Rápido</span>
            </div>

            <form action="{{ url_for('ventas.facturar_directo') }}" method="POST">
                <div class="header-info mb-4">
                    <label class="form-label fw-bold"><i class="fa-solid fa-user me-2"></i>Seleccionar Cliente:</label>
                    <select name="cliente_id" class="form-select shadow-sm" required>
                        <option value="" disabled selected>-- Seleccione un cliente --</option>
                        {% for c in clientes %}
                        <option value="{{ c.cliente_id }}">{{ c.nombre }} ({{ c.telefono }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle table-menu">
                        <thead>
                            <tr>
                                <th>Plato / Pizza</th>
                                <th class="text-center">Precio Unit.</th>
                                <th class="text-center" style="width: 150px;">Cantidad</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in menu %}
                            <tr>
                                <td>
                                    <span class="fw-bold">{{ p.nombre }}</span><br>
                                    <small class="text-muted">{{ p.categoria.nombre }}</small>
                                </td>
                                <td class="text-center">${{ "%.2f"|format(p.precio) }}</td>
                                <td>
                                    <input type="hidden" name="platos[]" value="{{ p.plato_id }}">
                                    <input type="number" name="cantidades[]" 
                                           class="form-control form-control-sm text-center input-cantidad" 
                                           value="0" min="0" data-precio="{{ p.precio }}">
                                </td>
                                <td class="text-end fw-bold text-muted monto-linea">$0.00</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="row justify-content-end mt-4">
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="resumen-subtotal">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>ITBIS (18%):</span>
                                    <span id="resumen-itbis">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 text-muted">
                                    <small>Propina Legal (10%):</small>
                                    <small>$0.00 (N/A)</small>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 mb-0">TOTAL:</span>
                                    <span id="resumen-total" class="monto-grande">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-vino w-100 mt-3 py-2 shadow border-0">
                            <i class="fa-solid fa-check-double me-2"></i>Finalizar Venta Directa
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>



<script>
    document.querySelectorAll('.input-cantidad').forEach(input => {
        input.addEventListener('input', function() {
            let subtotalGlobal = 0;
            
            document.querySelectorAll('.input-cantidad').forEach(i => {
                const cant = parseInt(i.value) || 0;
                const precio = parseFloat(i.dataset.precio);
                const linea = cant * precio;
                
                i.closest('tr').querySelector('.monto-linea').textContent = `$${linea.toFixed(2)}`;
                subtotalGlobal += linea;
            });

            // Lógica para pedidos PARA LLEVAR: Solo 18% ITBIS
            const itbis = subtotalGlobal * 0.18;
            const total = subtotalGlobal + itbis;

            document.getElementById('resumen-subtotal').textContent = `$${subtotalGlobal.toFixed(2)}`;
            document.getElementById('resumen-itbis').textContent = `$${itbis.toFixed(2)}`;
            document.getElementById('resumen-total').textContent = `$${total.toFixed(2)}`;
        });
    });
</script>
{% endblock %}
